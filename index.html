<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<title>Bookmarklet Kode OTP</title>
<style>
    body {font-family: monospace, sans-serif;background: #f4f6f8;color: #333;padding: 20px;}
    p {font-family: monospace}
    h1 {color: #2c3e50;font-size: 24px;}
    .container {background: white;padding: 20px;border-radius: 10px;max-width: 40em;margin: auto;box-shadow: 0 4px 10px rgba(0,0,0,0.1);}
    input[type="file"], input[type="text"] {margin-top: 10px;padding: 8px;font-family: monospace;border: 1px solid #ccc;border-radius: 6px;background: #f9f9f9;width: 100%;box-sizing: border-box;}
    #output {background: #1e1e1e;color: #00ff88;padding: 15px;border-radius: 6px;margin-top: 20px;font-family: monospace;white-space: pre-wrap;max-height: 400px;overflow-y: auto;}
    button {margin-top: 15px;padding: 8px 12px;background: #3498db;color: white;border: none;border-radius: 6px;cursor: pointer;font-family: monospace;}
    button:hover {background: #2980b9;}
    .radio-group {display: flex;gap: 15px;margin: 10px 0;}
    .radio-group label {display: flex;align-items: center;gap: 5px;cursor: pointer;transition: 0.2s;}
    .radio-group input[type="radio"] {accent-color: #007bff;transform: scale(1.2);}
    .footer {margin-top: 2rem;text-align: center;font-size: 0.875rem;color: #6b7280;}
    .footer a {color: #3b82f6;font-weight: 600;text-decoration: none;}
    .footer a:hover {text-decoration: underline;}
</style>
</head>
<body>
<div class="container">
	<h1>‚≠ê Bookmarklet Kode OTP</h1>
	<div style="display:flex; justify-content:space-between; align-items:center;">
	  <p style="margin:0;">Tutorial: <a style="text-decoration:none" href="https://youtu.be/29o-ych59Os" target="_blank">‚ñ∂Ô∏è Youtube - @danie_lung</a></p>
	  <p style="margin:0;">Ajak Ngopi: <a style="text-decoration:none" href="https://s.id/danielung" target="_blank">‚òïÔ∏è Tubruk</a></p>
	</div>
    <hr>
    <h3 style="margin-bottom: 5px">üëâ Generator Bookmarklet</h3>
	<p style="margin-top:0">Bookmarklet ini berfungsi untuk menghasilkan kode OTP sesuai secret yang Anda masukkan. Kode OTP akan langsung terisi sesuai penggunaan OTP yang Anda pilih.</p>
    <input type="text" id="bookmarkletCode" placeholder="Masukkan Kode Secret">
	<input type="text" id="bookmarkletNama" placeholder="Masukkan Nama Bookmarklet">
	<div class="radio-group">
		<p style="font-family: monospace, sans-serif;margin:0">Pilih Penggunaan OTP:</p>
		<label><input type="radio" name="bmOption" value="kode2fa" checked> Dapodik</label>
		<label><input type="radio" name="bmOption" value="totp_code"> SDM</label>
		<label><input type="radio" name="bmOption" value="otp"> SIASN</label>
        <label><input type="radio" name="bmOption" value="info_gtk"> Info GTK</label>
	</div>
    <button onclick="generateBookmarklet()">Generate Bookmarklet</button>
    <p style="margin: 24px 0;font-family: monospace, sans-serif">Bookmarklet: <a id="bookmarkletLink" href="#" target="_blank"></a></p>
	<hr>
    <h3 style="margin-bottom: 5px">üëâ Google Authenticator QR Decoder</h3>
    <p style="margin-top:0">Unggah gambar kode QR 2FA untuk mengekstrak akun dan secret-nya. Atau Anda bisa langsung menggunakan Generator Bookmarklet diatas jika sudah punya kode secret.</p>
    <input type="file" id="fileInput" accept="image/*">
    <pre id="output">Silakan Upload QR Google Authenticator</pre>
		<div class="footer">
			üìÇ Lihat kode sumber di <a href="https://github.com/danie-lung/bookmarklet_kode_otp" target="_blank">GitHub</a>
		</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/protobufjs/dist/protobuf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<script>
function generateBookmarklet() {
    const code = document.getElementById("bookmarkletCode").value.trim();
	const namacode = document.getElementById("bookmarkletNama").value.trim();
	const selectedOption = document.querySelector('input[name="bmOption"]:checked').value;

    // mapping selector
    const targetSelectors = {
        "kode2fa": "#kode2fa",
        "totp_code": "#totp_code",
        "otp": "#otp",
        "info_gtk": ".otp-input"
    };

    const selector = targetSelectors[selectedOption];

    if (!code) {
		alert("Masukkan kode secret terlebih dahulu.");
        return;
    } else if (!namacode) {
		alert("Masukkan nama bookmark terlebih dahulu.");
		return;
	}

    let jsCode = `
    var secretKey="${code}";
    function base32Decode(e){
        for(var t=e.toUpperCase().replace(/=+$/,"").replace(/\\s+/g,""),r=0,n=0,a=[],o=0;o<t.length;o++){
            var c="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567".indexOf(t[o]);
            if(-1===c)throw new Error("Invalid Base32 character: "+t[o]);
            n=n<<5|c,(r+=5)>=8&&(a.push(n>>>r-8&255),r-=8)
        }
        return new Uint8Array(a)
    }
    function intToBuffer(e){
        var t=new ArrayBuffer(8),r=new DataView(t),
            n=Math.floor(e/Math.pow(2,32)),a=e>>>0;
        return r.setUint32(0,n),r.setUint32(4,a),new Uint8Array(t)
    }
    function generateTOTP(e,t,r,n){
        t=t||6,r=r||30,n=n||"SHA-1";
        var a=base32Decode(e),o=Math.floor(Date.now()/1e3),c=intToBuffer(Math.floor(o/r));
        return crypto.subtle.importKey("raw",a,{name:"HMAC",hash:{name:n}},!1,["sign"])
        .then(function(e){return crypto.subtle.sign("HMAC",e,c)})
        .then(function(e){
            var r=new Uint8Array(e),n=15&r[r.length-1];
            return(((127&r[n])<<24|(255&r[n+1])<<16|(255&r[n+2])<<8|255&r[n+3])%Math.pow(10,t)).toString().padStart(t,"0")
        })
    }
    generateTOTP(secretKey).then(function(otp){
        if ("${selectedOption}" === "info_gtk") {
            var inputs = document.querySelectorAll("${selector}");
            if (!inputs || inputs.length === 0) {
                alert("Elemen OTP Info GTK tidak ditemukan (selector: ${selector})");
                return;
            }
            for (var i = 0; i < inputs.length && i < otp.length; i++) {
                inputs[i].value = otp[i];
                var ev = new Event('input', { bubbles: true });
                inputs[i].dispatchEvent(ev);
            }
        } else {
            var el = document.querySelector("${selector}");
            if (!el) {
                alert("Elemen target OTP tidak ditemukan (selector: ${selector}).");
                return;
            }
            if ('value' in el) el.value = otp;
            else el.textContent = otp;
            var ev = new Event('input', { bubbles: true });
            el.dispatchEvent(ev);
        }
    }).catch(function(err){
        alert("Gagal generate OTP: " + (err && err.message ? err.message : err));
    });
    `;

    const bookmarklet = "javascript:(function(){" + encodeURIComponent(jsCode) + "})();";
    const link = document.getElementById("bookmarkletLink");
    link.href = bookmarklet;
    link.textContent = document.getElementById("bookmarkletNama").value;
}
</script>
</body>
</html>
