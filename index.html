<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<title>Bookmarklet Kode OTP</title>
<style>
    body {
        font-family: 'Segoe UI', Tahoma, sans-serif;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        color: #333;
        padding: 20px;
        line-height: 1.6;
    }
    h1 {
        color: #2c3e50;
        font-size: 28px;
        text-align: center;
        margin-bottom: 10px;
    }
    .container {
        background: white;
        padding: 25px;
        border-radius: 15px;
        max-width: 700px;
        margin: auto;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    input[type="file"], input[type="text"] {
        margin-top: 10px;
        padding: 12px;
        font-family: monospace;
        border: 1px solid #d1d1d1;
        border-radius: 8px;
        background: #f9f9f9;
        width: 100%;
        box-sizing: border-box;
        transition: all 0.3s;
    }
    input[type="text"]:focus {
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        outline: none;
    }
    #output {
        background: #1e1e1e;
        color: #00ff88;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
        line-height: 1.5;
    }
    button {
        margin-top: 15px;
        padding: 12px 20px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-family: 'Segoe UI', sans-serif;
        font-weight: 600;
        width: 100%;
        transition: all 0.3s;
    }
    button:hover {
        background: #2980b9;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .radio-group {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin: 15px 0;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    .radio-group label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 8px 12px;
        background: white;
        border-radius: 6px;
        transition: all 0.2s;
        border: 1px solid #e0e0e0;
    }
    .radio-group label:hover {
        background: #e8f4fc;
        border-color: #3498db;
    }
    .radio-group input[type="radio"]:checked + span {
        font-weight: bold;
        color: #3498db;
    }
    .radio-group input[type="radio"] {
        accent-color: #3498db;
        transform: scale(1.2);
    }
    .footer {
        margin-top: 2rem;
        text-align: center;
        font-size: 0.875rem;
        color: #6b7280;
        padding-top: 15px;
        border-top: 1px solid #eee;
    }
    .footer a {
        color: #3b82f6;
        font-weight: 600;
        text-decoration: none;
    }
    .footer a:hover {
        text-decoration: underline;
    }
    .header-links {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 20px;
    }
    .header-links p {
        margin: 0;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .header-links a {
        display: flex;
        align-items: center;
        gap: 5px;
        text-decoration: none;
        color: #3498db;
        font-weight: 500;
    }
    .header-links a:hover {
        text-decoration: underline;
    }
    .info-box {
        background-color: #e8f4fc;
        border-left: 4px solid #3498db;
        padding: 15px;
        margin: 20px 0;
        border-radius: 6px;
        font-size: 0.95rem;
    }
    .info-box strong {
        color: #2c3e50;
    }
    .bookmarklet-instructions {
        background: #fff8e6;
        border-left: 4px solid #ffc107;
        padding: 15px;
        margin: 20px 0;
        border-radius: 6px;
        font-size: 0.9rem;
    }
    .highlight {
        background: #f0f7ff;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: monospace;
        color: #0066cc;
    }
    h3 {
        color: #2c3e50;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    h3::before {
        content: "‚Ä¢";
        color: #3498db;
        font-size: 1.5em;
    }
    pre {
        white-space: pre-wrap;
        font-family: monospace;
    }
    .qr-preview {
        max-width: 200px;
        max-height: 200px;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin: 10px 0;
    }
    .account-selector {
        margin: 15px 0;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    .account-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px;
        margin: 5px 0;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .account-item:hover {
        background: #e8f4fc;
        border-color: #3498db;
    }
    .account-item input[type="radio"] {
        accent-color: #3498db;
    }
    .account-details {
        flex: 1;
    }
    .account-name {
        font-weight: bold;
        color: #2c3e50;
    }
    .account-issuer {
        font-size: 0.9em;
        color: #6c757d;
    }
</style>
</head>
<body>
<div class="container">
    <h1>‚≠ê Bookmarklet Kode OTP</h1>
    
    <div class="header-links">
        <p>Tutorial: <a href="https://youtu.be/29o-ych59Os" target="_blank">‚ñ∂Ô∏è Youtube - @danie_lung</a></p>
        <p>Ajak Ngopi: <a href="https://s.id/danielung" target="_blank">‚òïÔ∏è Tubruk</a></p>
    </div>
    
    <hr>
    
    <h3>üëâ Generator Bookmarklet</h3>
    <p>Bookmarklet ini berfungsi untuk menghasilkan kode OTP sesuai secret yang Anda masukkan. Kode OTP akan langsung terisi sesuai penggunaan OTP yang Anda pilih.</p>
    
    <input type="text" id="bookmarkletCode" placeholder="Masukkan Kode Secret">
    <input type="text" id="bookmarkletNama" placeholder="Masukkan Nama Bookmarklet">
    
    <div class="radio-group">
        <p style="width: 100%; margin: 0 0 10px 0; font-weight: bold;">Pilih Penggunaan OTP:</p>
        <label><input type="radio" name="bmOption" value="kode2fa" checked><span>Dapodik</span></label>
        <label><input type="radio" name="bmOption" value="totp_code"><span>SDM</span></label>
        <label><input type="radio" name="bmOption" value="otp"><span>SIASN</span></label>
        <label><input type="radio" name="bmOption" value="info_gtk"><span>Info GTK</span></label>
    </div>
    
    <button onclick="generateBookmarklet()">Generate Bookmarklet</button>
    
    <p style="margin: 24px 0; font-family: monospace, sans-serif;">Bookmarklet: <a id="bookmarkletLink" href="#" target="_blank"></a></p>
    
    <div class="bookmarklet-instructions">
        <strong>Cara menggunakan:</strong> Setelah generate, seret link bookmarklet ke bilang penanda (bookmark bar) browser Anda. 
        Buka halaman target, lalu klik bookmarklet tersebut untuk mengisi kode OTP secara otomatis.
    </div>
    
    <div class="info-box">
        <strong>Info GTK:</strong> Fitur ini khusus untuk halaman <a href="https://info.gtk.dikdasmen.go.id/info" target="_blank">info.gtk.dikdasmen.go.id</a>. 
        Bookmarklet akan mengisi 6 digit kode OTP ke dalam input yang sesuai pada modal konfirmasi OTP.
    </div>
    
    <hr>
    
    <h3>üëâ Google Authenticator QR Decoder</h3>
    <p>Unggah gambar kode QR 2FA untuk mengekstrak akun dan secret-nya. Atau Anda bisa langsung menggunakan Generator Bookmarklet diatas jika sudah punya kode secret.</p>
    
    <input type="file" id="fileInput" accept="image/*">
    <img id="qrPreview" class="qr-preview" style="display: none;" alt="QR Preview">
    <div id="accountSelector" class="account-selector" style="display: none;">
        <h4>Pilih Akun OTP:</h4>
        <div id="accountList"></div>
        <button onclick="useSelectedAccount()" style="margin-top: 10px;">Gunakan Akun Terpilih</button>
    </div>
    <pre id="output">Silakan Upload QR Google Authenticator</pre>
    
    <div class="footer">
        üìÇ Lihat kode sumber di <a href="https://github.com/danie-lung/bookmarklet_kode_otp" target="_blank">GitHub</a>
    </div>
</div>

<script>
let parsedAccounts = [];

document.getElementById('fileInput').addEventListener('change', handleFile);

function handleFile(evt) {
    const file = evt.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        const preview = document.getElementById('qrPreview');
        
        img.onload = function() {
            // Show preview
            preview.src = e.target.result;
            preview.style.display = 'block';
            
            // Try multiple processing approaches
            processQRImage(img);
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function processQRImage(img) {
    document.getElementById('output').textContent = "üîç Memproses QR code...";
    
    // Try different canvas sizes and processing methods
    const sizes = [
        { width: img.width, height: img.height },
        { width: 400, height: 400 },
        { width: 600, height: 600 },
        { width: 800, height: 800 }
    ];
    
    let processed = false;
    
    sizes.forEach((size, index) => {
        if (processed) return;
        
        setTimeout(() => {
            if (processed) return;
            
            const canvas = document.createElement('canvas');
            canvas.width = size.width;
            canvas.height = size.height;
            const ctx = canvas.getContext('2d');
            
            // Clear canvas and draw image
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, size.width, size.height);
            
            // Try with different image processing
            if (index > 0) {
                // Enhance contrast for better QR reading
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // Simple contrast enhancement
                for (let i = 0; i < data.length; i += 4) {
                    const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                    const enhanced = avg > 128 ? 255 : 0;
                    data[i] = enhanced;     // Red
                    data[i + 1] = enhanced; // Green
                    data[i + 2] = enhanced; // Blue
                }
                
                ctx.putImageData(imageData, 0, 0);
            }
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            // Use jsQR if available
            if (typeof jsQR !== 'undefined') {
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });
                
                if (code && !processed) {
                    processed = true;
                    processQR(code.data);
                    return;
                }
                
                // Try with inversion
                const codeInverted = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "onlyInvert",
                });
                
                if (codeInverted && !processed) {
                    processed = true;
                    processQR(codeInverted.data);
                    return;
                }
                
                // Try with both
                const codeBoth = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "attemptBoth",
                });
                
                if (codeBoth && !processed) {
                    processed = true;
                    processQR(codeBoth.data);
                    return;
                }
            }
            
            // If this is the last attempt and nothing worked
            if (index === sizes.length - 1 && !processed) {
                document.getElementById('output').textContent = 
                    "‚ùå QR code tidak terbaca.\n\n" +
                    "Tips:\n" +
                    "‚Ä¢ Pastikan gambar QR jelas dan tidak buram\n" +
                    "‚Ä¢ Coba crop gambar agar hanya QR code yang terlihat\n" +
                    "‚Ä¢ Pastikan QR dari Google Authenticator\n" +
                    "‚Ä¢ Coba dengan gambar yang lebih terang/kontras tinggi";
            }
        }, index * 500); // Stagger the attempts
    });
}

// Base32 decode function
function base32Decode(encoded) {
    const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
    let bits = '';
    let result = [];
    
    // Remove padding and convert to uppercase
    encoded = encoded.toUpperCase().replace(/=+$/, '');
    
    // Convert each character to 5-bit binary
    for (let i = 0; i < encoded.length; i++) {
        const char = encoded[i];
        const index = alphabet.indexOf(char);
        if (index === -1) continue;
        bits += index.toString(2).padStart(5, '0');
    }
    
    // Convert 8-bit chunks to bytes
    for (let i = 0; i < bits.length - 7; i += 8) {
        const byte = parseInt(bits.substr(i, 8), 2);
        result.push(byte);
    }
    
    return new Uint8Array(result);
}

function processQR(qrText) {
    try {
        document.getElementById('output').textContent = "üìã Raw QR Data:\n" + qrText + "\n\nüîç Memproses...";
        
        if (qrText.startsWith("otpauth://")) {
            // Standard OTP format
            const url = new URL(qrText);
            const secret = url.searchParams.get("secret");
            const issuer = url.searchParams.get("issuer") || "(tidak ada)";
            const account = decodeURIComponent(url.pathname.split('/').pop() || "");
            
            if (secret) {
                document.getElementById('output').textContent =
                    `‚úÖ QR Code Berhasil Dibaca!\n\n` +
                    `üìå OTP Auth\n` +
                    `Nama   : ${account}\n` +
                    `Issuer : ${issuer}\n` +
                    `Secret : ${secret}\n\n` +
                    `üéØ Secret sudah otomatis diisi ke form diatas!`;
                    
                // Auto-fill the secret field
                document.getElementById('bookmarkletCode').value = secret;
                
                // Auto-fill name if available
                if (account && !document.getElementById('bookmarkletNama').value) {
                    document.getElementById('bookmarkletNama').value = account.replace(/[^a-zA-Z0-9\s]/g, '').trim();
                }
            } else {
                document.getElementById('output').textContent = "‚ö†Ô∏è Secret tidak ditemukan di QR.";
            }
            return;
        }
        
        if (qrText.startsWith("otpauth-migration://")) {
            // Google Authenticator migration format
            document.getElementById('output').textContent = "üîç Memproses Google Authenticator Migration...";
            
            try {
                const url = new URL(qrText);
                const data = url.searchParams.get("data");
                
                if (!data) {
                    throw new Error("Data parameter tidak ditemukan");
                }
                
                // Decode the base64 data
                const decodedData = atob(decodeURIComponent(data));
                
                // Parse the protobuf-like data (simplified parsing)
                parsedAccounts = parseGoogleAuthMigration(decodedData);
                
                if (parsedAccounts.length === 0) {
                    throw new Error("Tidak ada akun ditemukan dalam data migrasi");
                }
                
                // Show account selector
                showAccountSelector(parsedAccounts);
                
            } catch (error) {
                document.getElementById('output').textContent = 
                    `‚ùå Error parsing Google Authenticator migration:\n${error.message}\n\n` +
                    `Raw data: ${qrText}`;
            }
            return;
        }
        
        // Try to extract any URLs or secrets from the raw data
        if (qrText.includes("secret=")) {
            const secretMatch = qrText.match(/secret=([A-Z2-7]+)/i);
            if (secretMatch) {
                document.getElementById('output').textContent =
                    `‚úÖ Secret ditemukan!\n\n` +
                    `Secret : ${secretMatch[1]}\n\n` +
                    `üéØ Secret sudah otomatis diisi ke form diatas!`;
                document.getElementById('bookmarkletCode').value = secretMatch[1];
                return;
            }
        }
        
        document.getElementById('output').textContent = 
            "‚ö†Ô∏è Format QR tidak dikenali sebagai Google Authenticator.\n\n" +
            "üìã Raw Data:\n" + qrText + "\n\n" +
            "üí° Jika ini adalah QR 2FA, coba:\n" +
            "‚Ä¢ Screenshot ulang QR code\n" +
            "‚Ä¢ Pastikan QR dari Google Authenticator atau aplikasi 2FA lainnya";
    } catch (err) {
        document.getElementById('output').textContent = 
            "‚ùå Error memproses QR: " + err.message + "\n\n" +
            "üìã Raw Data:\n" + qrText;
    }
}

function parseGoogleAuthMigration(data) {
    const accounts = [];
    
    try {
        // This is a simplified parser for Google Authenticator migration format
        // The actual format is protobuf, but we'll try to extract basic info
        
        // Look for patterns that might contain secrets and names
        const bytes = new Uint8Array(data.split('').map(c => c.charCodeAt(0)));
        
        // Try to find base32-like strings (secrets are usually base32 encoded)
        const text = data.replace(/[^\x20-\x7E]/g, ''); // Keep only printable ASCII
        
        // Look for potential secrets (base32 strings)
        const secretMatches = text.match(/[A-Z2-7]{16,}/g) || [];
        
        // Look for email-like patterns or account names
        const nameMatches = text.match(/[\w\.\-]+@[\w\.\-]+|[A-Za-z][\w\s\-\.]+/g) || [];
        
        if (secretMatches.length > 0) {
            secretMatches.forEach((secret, index) => {
                if (secret.length >= 16) { // Valid base32 secrets are usually 16+ chars
                    const accountName = nameMatches[index] || `Account ${index + 1}`;
                    accounts.push({
                        name: accountName.trim(),
                        secret: secret,
                        issuer: 'Google Authenticator Export'
                    });
                }
            });
        }
        
        // If no accounts found, try a different approach
        if (accounts.length === 0) {
            // Look for the specific pattern in your data
            // The secret might be encoded differently
            const base64Pattern = /[A-Za-z0-9+/]{20,}={0,2}/g;
            const base64Matches = data.match(base64Pattern) || [];
            
            base64Matches.forEach((b64, index) => {
                try {
                    // Try to decode and see if it looks like a secret
                    const decoded = atob(b64);
                    if (decoded.length >= 10) {
                        // Convert to base32 for TOTP
                        const secret = arrayToBase32(new Uint8Array(decoded.split('').map(c => c.charCodeAt(0))));
                        if (secret.length >= 16) {
                            accounts.push({
                                name: `Extracted Account ${index + 1}`,
                                secret: secret,
                                issuer: 'Migration Data'
                            });
                        }
                    }
                } catch (e) {
                    // Skip invalid base64
                }
            });
        }
        
    } catch (error) {
        console.error('Error parsing migration data:', error);
    }
    
    return accounts;
}

function arrayToBase32(bytes) {
    const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
    let bits = '';
    let result = '';
    
    // Convert bytes to binary string
    for (let i = 0; i < bytes.length; i++) {
        bits += bytes[i].toString(2).padStart(8, '0');
    }
    
    // Convert 5-bit chunks to base32
    for (let i = 0; i < bits.length; i += 5) {
        const chunk = bits.substr(i, 5).padEnd(5, '0');
        const index = parseInt(chunk, 2);
        result += alphabet[index];
    }
    
    return result;
}

function showAccountSelector(accounts) {
    const selector = document.getElementById('accountSelector');
    const accountList = document.getElementById('accountList');
    
    accountList.innerHTML = '';
    
    accounts.forEach((account, index) => {
        const accountDiv = document.createElement('div');
        accountDiv.className = 'account-item';
        accountDiv.innerHTML = `
            <input type="radio" name="selectedAccount" value="${index}" ${index === 0 ? 'checked' : ''}>
            <div class="account-details">
                <div class="account-name">${account.name}</div>
                <div class="account-issuer">${account.issuer}</div>
                <div style="font-family: monospace; font-size: 0.8em; color: #666;">Secret: ${account.secret.substring(0, 8)}...</div>
            </div>
        `;
        accountList.appendChild(accountDiv);
    });
    
    selector.style.display = 'block';
    
    document.getElementById('output').textContent = 
        `‚úÖ Google Authenticator Migration berhasil diparse!\n\n` +
        `Ditemukan ${accounts.length} akun OTP.\n` +
        `Silakan pilih akun yang ingin digunakan di atas.`;
}

function useSelectedAccount() {
    const selectedRadio = document.querySelector('input[name="selectedAccount"]:checked');
    if (!selectedRadio) {
        alert('Pilih akun terlebih dahulu');
        return;
    }
    
    const accountIndex = parseInt(selectedRadio.value);
    const account = parsedAccounts[accountIndex];
    
    if (account) {
        document.getElementById('bookmarkletCode').value = account.secret;
        document.getElementById('bookmarkletNama').value = account.name.replace(/[^a-zA-Z0-9\s]/g, '').trim();
        
        document.getElementById('output').textContent = 
            `‚úÖ Akun terpilih berhasil digunakan!\n\n` +
            `Nama   : ${account.name}\n` +
            `Issuer : ${account.issuer}\n` +
            `Secret : ${account.secret}\n\n` +
            `üéØ Data sudah otomatis diisi ke form diatas!`;
        
        document.getElementById('accountSelector').style.display = 'none';
    }
}

function generateBookmarklet() {
    const code = document.getElementById("bookmarkletCode").value.trim();
    const namacode = document.getElementById("bookmarkletNama").value.trim();
    const selectedOption = document.querySelector('input[name="bmOption"]:checked').value;

    // Mapping selector untuk setiap jenis OTP
    const targetSelectors = {
        "kode2fa": "#kode2fa",
        "totp_code": "#totp_code",
        "otp": "#otp",
        "info_gtk": ".otp-input"  // 6 input fields dengan class ini
    };

    const selector = targetSelectors[selectedOption];

    if (!code) {
        alert("Masukkan kode secret terlebih dahulu.");
        return;
    } else if (!namacode) {
        alert("Masukkan nama bookmark terlebih dahulu.");
        return;
    }

    // Kode JavaScript untuk bookmarklet
    let jsCode = `
(function() {
    var secretKey = "${code}";
    
    function base32Decode(e) {
        for(var t = e.toUpperCase().replace(/=+$/, "").replace(/\\s+/g, ""), r = 0, n = 0, a = [], o = 0; o < t.length; o++) {
            var c = "ABCDEFGHIJKLMNOPQRSTUVWXYZ234567".indexOf(t[o]);
            if (-1 === c) throw new Error("Invalid Base32 character: " + t[o]);
            n = n << 5 | c;
            (r += 5) >= 8 && (a.push(n >>> r - 8 & 255), r -= 8);
        }
        return new Uint8Array(a);
    }
    
    function intToBuffer(e) {
        var t = new ArrayBuffer(8), r = new DataView(t),
            n = Math.floor(e / Math.pow(2, 32)), a = e >>> 0;
        return r.setUint32(0, n), r.setUint32(4, a), new Uint8Array(t);
    }
    
    function generateTOTP(e, t, r, n) {
        t = t || 6, r = r || 30, n = n || "SHA-1";
        var a = base32Decode(e), o = Math.floor(Date.now() / 1000), c = intToBuffer(Math.floor(o / r));
        return crypto.subtle.importKey("raw", a, {name: "HMAC", hash: {name: n}}, false, ["sign"])
            .then(function(e) { return crypto.subtle.sign("HMAC", e, c); })
            .then(function(e) {
                var r = new Uint8Array(e), n = 15 & r[r.length - 1];
                return (((127 & r[n]) << 24 | (255 & r[n+1]) << 16 | (255 & r[n+2]) << 8 | 255 & r[n+3]) % Math.pow(10, t)).toString().padStart(t, "0");
            });
    }
    
    function waitForElements(selector, maxAttempts, callback) {
        var attempts = 0;
        var interval = setInterval(function() {
            var elements = document.querySelectorAll(selector);
            attempts++;
            
            if (elements.length > 0) {
                clearInterval(interval);
                callback(elements);
            } else if (attempts >= maxAttempts) {
                clearInterval(interval);
                callback(null);
            }
        }, 200);
    }
    
    generateTOTP(secretKey).then(function(otp) {
        if ("${selectedOption}" === "info_gtk") {
            // Khusus untuk Info GTK - tunggu modal muncul dan isi 6 input field terpisah
            waitForElements("${selector}", 25, function(inputs) {
                if (!inputs || inputs.length === 0) {
                    alert("Modal OTP Info GTK tidak ditemukan. Pastikan modal OTP sudah terbuka.");
                    return;
                }
                
                if (inputs.length < 6) {
                    alert("Ditemukan " + inputs.length + " input, tetapi diperlukan 6 input untuk OTP");
                    return;
                }
                
                // Isi masing-masing input dengan digit OTP yang sesuai
                for (var i = 0; i < 6 && i < otp.length; i++) {
                    inputs[i].value = otp[i];
                    
                    // Trigger berbagai event untuk memastikan validasi berjalan
                    var events = ['input', 'change', 'keyup', 'blur'];
                    events.forEach(function(eventType) {
                        var event = new Event(eventType, { bubbles: true });
                        inputs[i].dispatchEvent(event);
                    });
                    
                    // Fokus ke input berikutnya (simulasi user typing)
                    if (i < 5) {
                        setTimeout(function(index) {
                            return function() {
                                if (inputs[index + 1]) {
                                    inputs[index + 1].focus();
                                }
                            };
                        }(i), 50 * (i + 1));
                    }
                }
                
                // Beri umpan balik bahwa OTP telah diisi
                console.log("Kode OTP Info GTK telah diisi: " + otp);
                
                // Tampilkan notifikasi sukses
                setTimeout(function() {
                    alert("‚úÖ Kode OTP " + otp + " berhasil diisi!");
                }, 300);
            });
        } else {
            // Untuk opsi lainnya (Dapodik, SDM, SIASN)
            var el = document.querySelector("${selector}");
            if (!el) {
                alert("Elemen target OTP tidak ditemukan (selector: ${selector}).");
                return;
            }
            
            if ('value' in el) {
                el.value = otp;
            } else {
                el.textContent = otp;
            }
            
            // Trigger event untuk memicu validasi
            var events = ['input', 'change', 'keyup'];
            events.forEach(function(eventType) {
                var event = new Event(eventType, { bubbles: true });
                el.dispatchEvent(event);
            });
            
            // Beri umpan balik bahwa OTP telah diisi
            console.log("Kode OTP telah diisi: " + otp);
            alert("‚úÖ Kode OTP " + otp + " berhasil diisi!");
        }
    }).catch(function(err) {
        alert("‚ùå Gagal generate OTP: " + (err && err.message ? err.message : err));
    });
})();
`;

    // Encode dan buat bookmarklet
    const encodedJsCode = encodeURIComponent(jsCode.replace(/\s+/g, ' '));
    const bookmarklet = "javascript:" + encodedJsCode;
    
    const link = document.getElementById("bookmarkletLink");
    link.href = bookmarklet;
    link.textContent = namacode;
    
    // Tambahkan instruksi drag and drop
    alert("Bookmarklet berhasil dibuat! Seret link di atas ke bilang bookmark browser Anda.");
}
</script>

<!-- Load external libraries -->
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
</body>
</html>
