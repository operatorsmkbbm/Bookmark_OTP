<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>OTP Generator</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; }
    label, select, input, button { display: block; margin: 8px 0; }
    select, input { padding: 5px; width: 100%; }
    button { padding: 8px; cursor: pointer; }
  </style>
</head>
<body>
  <h2>OTP Generator</h2>

  <label for="service">Pilih Layanan:</label>
  <select id="service">
    <option value="dapodik">Dapodik</option>
    <option value="sdm">SDM</option>
    <option value="siasn">SIASN</option>
    <option value="info_gtk">Info GTK</option>
  </select>

  <label for="secret">Masukkan Secret Key (Base32):</label>
  <input type="text" id="secret" placeholder="contoh: JBSWY3DPEHPK3PXP" />

  <button id="generateBtn">üîë Generate & Isi OTP</button>

  <script src="https://cdn.jsdelivr.net/npm/otpauth/dist/otpauth.umd.min.js"></script>
  <script>
    // Mapping selector OTP sesuai layanan
    const otpSelectors = {
      dapodik: "input[name='otp']",
      sdm: "input[name='otp']",
      siasn: "input[name='otp']",
      info_gtk: "form#otpForm input.otp-input"
    };

    // Fungsi generate OTP
    function generateTOTP(secretKey) {
      try {
        const totp = new OTPAuth.TOTP({
          issuer: "MyApp",
          label: "User",
          algorithm: "SHA1",
          digits: 6,
          period: 30,
          secret: OTPAuth.Secret.fromBase32(secretKey)
        });
        return totp.generate();
      } catch (e) {
        alert("‚ùå Secret Key tidak valid!");
        throw e;
      }
    }

    // Fungsi isi OTP untuk Info GTK (6 kotak input)
    function fillOtpFields(otp, selector, maxRetries = 10, retryDelay = 500) {
      let retryCount = 0;

      function tryFill() {
        const inputs = document.querySelectorAll(selector);

        if (inputs && inputs.length >= 6) {
          for (let i = 0; i < 6; i++) {
            if (i < otp.length) {
              inputs[i].value = otp[i];
              inputs[i].dispatchEvent(new Event('input', { bubbles: true }));
            }
          }
          console.log("‚úÖ Kode OTP Info GTK diisi:", otp);

          // Klik tombol konfirmasi otomatis
          const confirmBtn = document.querySelector("button.btn.btn-primary.mt-3");
          if (confirmBtn) {
            setTimeout(() => confirmBtn.click(), 500);
          } else {
            console.warn("‚ö†Ô∏è Tombol Konfirmasi tidak ditemukan!");
          }
          return true;
        } else if (retryCount < maxRetries) {
          retryCount++;
          setTimeout(tryFill, retryDelay);
          return false;
        } else {
          alert("‚ùå Tidak dapat menemukan elemen OTP Info GTK. Pastikan modal OTP sudah terbuka.");
          return false;
        }
      }
      return tryFill();
    }

    // Event tombol Generate
    document.getElementById("generateBtn").addEventListener("click", function() {
      const service = document.getElementById("service").value;
      const secret = document.getElementById("secret").value.trim();
      const selector = otpSelectors[service];

      if (!secret) {
        alert("Masukkan Secret Key dulu!");
        return;
      }

      const otp = generateTOTP(secret);
      console.log("üî¢ OTP:", otp);

      if (service === "info_gtk") {
        fillOtpFields(otp, selector);
      } else {
        const el = document.querySelector(selector);
        if (!el) {
          alert(`‚ùå Elemen target OTP tidak ditemukan (selector: ${selector}).`);
          return;
        }
        if ('value' in el) {
          el.value = otp;
        } else {
          el.textContent = otp;
        }
        el.dispatchEvent(new Event('input', { bubbles: true }));
        console.log("‚úÖ Kode OTP diisi:", otp);
      }
    });
  </script>
</body>
</html>
